<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Grades</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo">
                <img src="images/logo-full.webp" alt="Clear University" width="150">
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#" id="dashboardLink"> Dashboard</a></li>
                    <li><a href="#" id="coursesLink"> Courses</a></li>
                    <li class="active"><a href="#" id="gradesLink"> Grades</a></li>
                    <li><a href="#" id="scheduleLink"> Schedule</a></li>
                    <li><a href="#" id="profileLink"> Profile</a></li>
                    <li><a href="#" id="feesLink"> Fees</a></li>
                </ul>
            </nav>
        </aside>
        <main class="main-content">
            <header class="header">
                <h1 id="welcome">Grades for Lovepreet Singh</h1>
            </header>

            <div class="grades-layout">
                <div class="semester-summary card">
                    <div class="card-header">
                        <h3>Semester Summary</h3>
                    </div>
                    <div class="chart-container">
                        <div class="circular-progress">
                            <div class="inner-circle">GPA: <span id="gpaValue">8.5</span></div>
                        </div>
                    </div>
                    <div class="semester-legend" id="semesterLegend">
                        <!-- Semester legends will be inserted here by JavaScript -->
                    </div>
                </div>
                <div class="course-grades card">
                    <div class="card-header">
                        <h3>Course Grades</h3>
                    </div>
                    <div class="grades-table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Course Code</th>
                                    <th>Course Name</th>
                                    <th>Credits</th>
                                    <th>Grade</th>
                                    <th>Points</th>
                                </tr>
                            </thead>
                            <tbody id="courseGradesTableBody">
                                <!-- Course grades will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="grade-distribution card">
                    <h3>Grade Distribution</h3>
                    <div class="chart-container">
                        <canvas id="gradeDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="loader.js"></script>
    <script>
        async function main() {
            const data = await loadStudent();
            const fullName = `${data.firstName} ${data.middleName ? data.middleName + ' ' : ''}${data.lastName}`;
            document.getElementById("welcome").textContent = `Grades for ${fullName}`;

            // Sidebar links
            const rollNumber = data.rollNumber;
            document.getElementById("dashboardLink").href = "dashboard.html?rollNumber=" + rollNumber;
            document.getElementById("coursesLink").href = "courses.html?rollNumber=" + rollNumber;
            document.getElementById("gradesLink").href = "grades.html?rollNumber=" + rollNumber;
            document.getElementById("scheduleLink").href = "schedule.html?rollNumber=" + rollNumber;
            document.getElementById("profileLink").href = "profile.html?rollNumber=" + rollNumber;
            document.getElementById("feesLink").href = "fees.html?rollNumber=" + rollNumber;

            
            // Populate Course Grades table
            const courseGradesTableBody = document.getElementById("courseGradesTableBody");
            courseGradesTableBody.innerHTML = '';
            let totalCredits = 0;
            let totalGradePoints = 0;
            const gradesBySemester = {};
            const gradeCounts = {};

            const gradeToPoints = {
                "A+": 5.0, "A": 4.5, "A-": 4.0,
                "B+": 3.5, "B": 3.0, "B-": 2.5,
                "C+": 2.0, "C": 1.5, "C-": 1.0,
                "D+": 0.5, "D": 0.0, "F": 0.0
            };

            data.grades.forEach(gradeItem => {
                const course = data.courses.find(c => c.id === gradeItem.courseCode);
                const gradePoints = gradeToPoints[gradeItem.grade] || 0;
                const earnedPoints = gradePoints * gradeItem.credits;

                totalCredits += gradeItem.credits;
                totalGradePoints += earnedPoints;

                if (!gradesBySemester[gradeItem.semester]) {
                    gradesBySemester[gradeItem.semester] = { totalCredits: 0, totalGradePoints: 0 };
                }
                gradesBySemester[gradeItem.semester].totalCredits += gradeItem.credits;
                gradesBySemester[gradeItem.semester].totalGradePoints += earnedPoints;

                gradeCounts[gradeItem.grade] = (gradeCounts[gradeItem.grade] || 0) + 1;

                const row = `
                    <tr>
                        <td>${gradeItem.courseCode}</td>
                        <td>${course ? course.name : gradeItem.courseCode}</td>
                        <td>${gradeItem.credits}</td>
                        <td>${gradeItem.grade}</td>
                        <td>${gradePoints.toFixed(1)}</td>
                    </tr>
                `;
                courseGradesTableBody.insertAdjacentHTML("beforeend", row);
            });

            // Calculate GPA
            const gpa = totalCredits > 0 ? (totalGradePoints / totalCredits).toFixed(1) : "0.0";
            document.getElementById("gpaValue").textContent = gpa;

            // Semester GPA
            const semesterLegend = document.getElementById("semesterLegend");
            let semesterColors = ['#007bff', '#e0e0e0', '#34a853', '#fbbc05', '#ea4335']; // Add more colors if needed
            let colorIndex = 0;
            for (const semesterName in gradesBySemester) {
                const semesterCgpa = gradesBySemester[semesterName].totalCredits > 0
                    ? (gradesBySemester[semesterName].totalGradePoints / gradesBySemester[semesterName].totalCredits).toFixed(1)
                    : "0.0";
                
                const legendItem = `
                    <div class="legend-item">
                        <span class="color-box" style="background-color: ${semesterColors[colorIndex % semesterColors.length]};"></span> ${semesterName}: <span id="semester${colorIndex + 1}Cgpa">${semesterCgpa}</span>
                    </div>
                `;
                semesterLegend.insertAdjacentHTML("beforeend", legendItem);
                colorIndex++;
            }

            // Grade Distribution Chart
            const gradeLabels = ["A+", "A", "A-", "B+", "B", "B-", "C+", "C", "C-", "D+", "D", "F"];
            const gradeData = gradeLabels.map(label => gradeCounts[label] || 0);

            const ctx = document.getElementById('gradeDistributionChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: gradeLabels,
                    datasets: [{
                        label: 'Number of Courses',
                        data: gradeData,
                        backgroundColor: '#4285f4',
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Courses'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Grade'
                            }
                        }
                    }
                }
            });
        }
        main();
    </script>
</body>
</html>